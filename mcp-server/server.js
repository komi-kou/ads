const express = require('express');
const cors = require('cors');
const axios = require('axios');

const app = express();
const PORT = process.env.MCP_SERVER_PORT || 3001;

app.use(cors());
app.use(express.json());

// MCP endpoints for Meta Ads
app.post('/mcp/meta/accounts', async (req, res) => {
  try {
    const { accessToken } = req.body;
    const response = await axios.get(
      `https://graph.facebook.com/v18.0/me/adaccounts`,
      {
        params: {
          access_token: accessToken,
          fields: 'id,name,currency,timezone_name,account_status',
        },
      }
    );
    res.json(response.data);
  } catch (error) {
    console.error('Meta API Error:', error);
    res.status(500).json({ error: 'Failed to fetch Meta accounts' });
  }
});

app.post('/mcp/meta/insights', async (req, res) => {
  try {
    const { accessToken, accountId, dateRange } = req.body;
    const response = await axios.get(
      `https://graph.facebook.com/v18.0/${accountId}/insights`,
      {
        params: {
          access_token: accessToken,
          fields: 'impressions,clicks,spend,cpm,cpc,ctr,conversions,cost_per_conversion',
          time_range: JSON.stringify(dateRange),
          time_increment: 1,
        },
      }
    );
    res.json(response.data);
  } catch (error) {
    console.error('Meta Insights Error:', error);
    res.status(500).json({ error: 'Failed to fetch Meta insights' });
  }
});

// MCP endpoints for Google Ads
app.post('/mcp/google/accounts', async (req, res) => {
  try {
    const { accessToken, developerToken, customerId } = req.body;
    
    // Google Ads API implementation
    const response = await axios.post(
      `https://googleads.googleapis.com/v15/customers/${customerId}/googleAds:searchStream`,
      {
        query: `
          SELECT
            customer.id,
            customer.descriptive_name,
            customer.currency_code,
            customer.time_zone
          FROM customer
        `,
      },
      {
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'developer-token': developerToken,
        },
      }
    );
    res.json(response.data);
  } catch (error) {
    console.error('Google Ads API Error:', error);
    res.status(500).json({ error: 'Failed to fetch Google accounts' });
  }
});

app.post('/mcp/google/insights', async (req, res) => {
  try {
    const { accessToken, developerToken, customerId, dateRange } = req.body;
    
    const response = await axios.post(
      `https://googleads.googleapis.com/v15/customers/${customerId}/googleAds:searchStream`,
      {
        query: `
          SELECT
            metrics.impressions,
            metrics.clicks,
            metrics.cost_micros,
            metrics.average_cpc,
            metrics.ctr,
            metrics.conversions,
            metrics.cost_per_conversion,
            segments.date
          FROM customer
          WHERE segments.date BETWEEN '${dateRange.start}' AND '${dateRange.end}'
        `,
      },
      {
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'developer-token': developerToken,
        },
      }
    );
    res.json(response.data);
  } catch (error) {
    console.error('Google Ads Insights Error:', error);
    res.status(500).json({ error: 'Failed to fetch Google insights' });
  }
});

// Analysis endpoint for Claude integration
app.post('/mcp/analyze', async (req, res) => {
  try {
    const { platform, data, prompt } = req.body;
    
    // Format data for analysis
    const formattedData = {
      platform,
      metrics: data.metrics,
      campaigns: data.campaigns,
      insights: data.insights,
      timeRange: data.timeRange,
    };

    // ????????????????
    const metrics = data.metrics || {};
    const insights = [];
    const recommendations = [];

    // CTR??
    const ctr = parseFloat(metrics.ctr || 0);
    if (ctr > 3) {
      insights.push('CTR??????????????????????????????');
    } else if (ctr < 1) {
      insights.push('CTR?????????????????????????????');
      recommendations.push('??????????A/B??????????????????????????????');
    }

    // CPC??
    const cpc = parseFloat(platform === 'meta' ? (metrics.cpc || 0) : (metrics.averageCpc || 0));
    if (cpc > 150) {
      insights.push('CPC????????????????????????');
      recommendations.push('?????????????????????????????????');
    } else if (cpc < 100) {
      insights.push('CPC?????????????????');
    }

    // ?????????
    const conversions = parseInt(metrics.conversions || 0);
    if (conversions > 0) {
      const costPerConversion = parseFloat(
        platform === 'meta' ? (metrics.cost_per_conversion || 0) : (metrics.costPerConversion || 0)
      );
      if (costPerConversion < 1000) {
        insights.push('??????????????????????????????????????????');
        recommendations.push('???????????????????????????????????????');
      } else if (costPerConversion > 2000) {
        insights.push('??????????????????????????????????????????????');
        recommendations.push('???????????????????????????????????????');
      }
    }

    // ??????
    const platformName = platform === 'meta' ? 'Meta' : 'Google';
    const impressions = metrics.impressions ? parseInt(metrics.impressions).toLocaleString() : '0';
    const clicks = metrics.clicks ? parseInt(metrics.clicks).toLocaleString() : '0';
    const spend = platform === 'meta' 
      ? parseFloat(metrics.spend || 0).toLocaleString()
      : (parseInt(metrics.costMicros || 0) / 1000000).toLocaleString();

    const summary = `${platformName}?????????????
?????????????????????${impressions}?????${clicks}????${spend}????
CTR?${ctr}%??${ctr > 2 ? '????????' : '????????'}?????
${conversions > 0 ? `?????????${conversions}??????????????${parseFloat(platform === 'meta' ? (metrics.cost_per_conversion || 0) : (metrics.costPerConversion || 0)).toFixed(2)}???` : ''}`;

    // ???????????????
    if (platform === 'meta') {
      recommendations.push('???????????????????????????????');
      recommendations.push('?????????????????');
      recommendations.push('????????????????????');
    } else {
      recommendations.push('??????????????????????');
      recommendations.push('??????????????');
      recommendations.push('???????????????');
    }

    const analysis = {
      summary: summary || `Analysis for ${platform} account`,
      insights: insights.length > 0 ? insights : [
        '??????????????????????',
        '?????????????????????????????',
      ],
      recommendations: recommendations.length > 0 ? recommendations : [
        '?????????????????????????',
        'A/B????????????????????????????',
      ],
    };

    res.json({ analysis, data: formattedData });
  } catch (error) {
    console.error('Analysis Error:', error);
    res.status(500).json({ error: 'Failed to analyze data' });
  }
});

// Health check
app.get('/health', (req, res) => {
  res.json({ status: 'healthy', version: '1.0.0' });
});

app.listen(PORT, () => {
  console.log(`MCP Server running on port ${PORT}`);
});